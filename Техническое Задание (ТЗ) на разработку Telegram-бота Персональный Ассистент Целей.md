# Техническое Задание (ТЗ) на разработку Telegram-бота "Персональный Ассистент Целей"

**Оглавление:**

1.  Общие Положения
2.  Требования к Окружению и Технологиям
3.  Структура Проекта
4.  Конфигурация и Безопасность
5.  Структура Данных (Google Sheets)
6.  Команды Бота (Пользовательский Интерфейс)
7.  Логика Работы Основных Модулей
    * 7.1. Модуль Обработчиков Telegram (`handlers/`)
    * 7.2. Модуль Ядра (`core/`)
    * 7.3. Модуль LLM (`llm/`)
    * 7.4. Модуль Google Sheets (`sheets/`)
    * 7.5. Модуль Планировщика (`scheduler/`)
8.  Обработка Ошибок
9.  Журналирование (Логирование)

---

**1. Общие Положения**

* **1.1. Цель Продукта:** Разработать Telegram-бота (@Target_Assist_Bot), предоставляющего пользователям инструменты для постановки личных целей (со сроком до 3 месяцев), автоматической генерации ежедневного плана задач, отслеживания прогресса выполнения и получения мотивационной поддержки.
* **1.2. Основные Пользователи:** Школьники, студенты, а также любые пользователи, желающие улучшить навыки достижения целей и самоорганизации.
* **1.3. Ключевые Особенности:**
    * Интерфейс через Telegram.
    * Использование LLM (модель OpenAI) для генерации планов и мотивации.
    * Хранение данных пользователя в персональной Google Таблице.
    * Автоматические напоминания и запросы статуса через планировщик.
    * Поддержка одной активной цели на пользователя.

**2. Требования к Окружению и Технологиям**

* **2.1. Язык Программирования:** Python >= 3.12.
* **2.2. Основные Библиотеки:**
    * `python-telegram-bot` (>= 20.x): для взаимодействия с Telegram Bot API.
    * `openai` (>= 1.x): для взаимодействия с OpenAI API.
    * `gspread` (актуальная версия): для работы с Google Sheets API.
    * `google-auth` (актуальная версия): для аутентификации в Google API.
    * `APScheduler` (актуальная версия): для планирования фоновых задач.
    * `python-dotenv` (актуальная версия): для загрузки переменных окружения.
    * `pytz` (актуальная версия): для работы с часовыми поясами.
* **2.3. Среда Выполнения:** VPS-сервер под управлением Linux (рекомендуется Ubuntu 24.04 LTS или новее) или аналогичная облачная платформа/PaaS.
* **2.4. База Данных:** На данном этапе не используется. Состояние хранится в Google Sheets и временно в памяти бота (словарь Python).

**3. Структура Проекта**

```
goal-assistant/
├── .env                   # Файл с секретными данными (не хранится в Git)
├── .env.example           # Пример файла .env
├── google_credentials.json # Файл учетных данных Google Service Account
├── requirements.txt       # Зависимости проекта
├── main.py                # Точка входа, инициализация бота
├── config.py              # Загрузка конфигурации, константы
├── core/                  # Основная бизнес-логика
│   ├── __init__.py
│   └── goal_manager.py    # Логика управления целями и планами
├── handlers/              # Обработчики Telegram
│   ├── __init__.py
│   ├── common.py          # Обработчики /start, /help, /cancel
│   ├── goal_setting.py    # Обработчики диалога /setgoal
│   └── task_management.py # Обработчики /today, /check, /status, /motivation
├── llm/                   # Взаимодействие с LLM
│   ├── __init__.py
│   ├── client.py          # Клиент OpenAI API
│   └── prompts.py         # Шаблоны промптов
├── sheets/                # Взаимодействие с Google Sheets
│   ├── __init__.py
│   └── client.py          # Клиент Google Sheets API
├── scheduler/             # Планировщик задач
│   ├── __init__.py
│   └── tasks.py           # Настройка и запуск задач APScheduler
├── utils/                 # Вспомогательные утилиты
│   ├── __init__.py
│   └── helpers.py         # Общие вспомогательные функции (например, форматирование дат)
├── logs/                  # Директория для файлов логов (если используется FileHandler)
│   └── bot.log
└── tests/                 # Модульные и интеграционные тесты
    ├── __init__.py
    └── ...
```

**4. Конфигурация и Безопасность**

* **4.1. Управление Секретами:** Все секретные данные (токены, ключи API, пути к файлам) должны загружаться из файла `.env` с помощью `python-dotenv`. Файл `.env` не должен включаться в систему контроля версий (добавить в `.gitignore`).
* **4.2. Структура `.env` файла:**
    ```plaintext
    # .env example
    # Telegram
    TELEGRAM_BOT_TOKEN="ВАШ_ТЕЛЕГРАМ_ТОКЕН"
    
    # OpenAI
    OPENAI_API_KEY="ВАШ_OPENAI_КЛЮЧ"
    OPENAI_MODEL="gpt-4o-mini" # Или другая актуальная модель
    
    # Google
    GOOGLE_CREDENTIALS_PATH="google_credentials.json" # Путь к файлу JSON
    
    # Scheduler
    SCHEDULER_TIMEZONE="Europe/Moscow" # Часовой пояс для планировщика
    MORNING_REMINDER_TIME="08:00"      # Время утреннего напоминания
    EVENING_REMINDER_TIME="20:00"     # Время вечернего напоминания
    MOTIVATION_INTERVAL_HOURS="8"     # Интервал для мотивационных сообщений (в часах)
    
    # Logging
    LOG_LEVEL="INFO" # Уровень логирования (DEBUG, INFO, WARNING, ERROR)
    
    # Optional
    # ADMIN_TELEGRAM_ID="ID_АДМИНИСТРАТОРА"
    ```
* **4.3. Файл Учетных Данных Google:** Файл `google_credentials.json` должен быть получен из Google Cloud Console для сервисного аккаунта с правами доступа к Google Drive API и Google Sheets API. Путь к файлу указывается в `.env`.

---
---

**5. Структура Данных (Google Sheets)**

* **5.1. Именование Таблицы:** Для каждого пользователя создается отдельная таблица с именем `TargetAssistant_<TelegramID>`, где `<TelegramID>` - уникальный числовой идентификатор пользователя в Telegram.
* **5.2. Лист `GoalInfo`:**
    * **Назначение:** Хранение метаданных текущей активной цели пользователя. При установке новой цели через `/setgoal` *все данные на обоих листах (`GoalInfo` и `Plan`)* для этого пользователя **удаляются** перед записью новой информации.
    * **Столбцы:**
        * `A: Parameter` (Строка): Название параметра (например, "Goal Text", "Deadline Date", "Available Time", "Start Date", "Spreadsheet URL").
        * `B: Value` (Строка): Значение параметра. Даты хранятся в формате ГГГГ-ММ-ДД.
        * `C: Description` (Строка): Описание параметра (для информации).
* **5.3. Лист `Plan`:**
    * **Назначение:** Хранение сгенерированного ежедневного плана задач.
    * **Столбцы:**
        * `A: Date` (Дата, формат ГГГГ-ММ-ДД): Дата, к которой относится задача. Является уникальным ключом для строки в рамках одного плана.
        * `B: DayOfWeek` (Строка): День недели на русском языке (Понедельник, Вторник...).
        * `C: Task` (Строка): Текст конкретной задачи на этот день (генерируется LLM).
        * `D: Status` (Строка): Статус выполнения задачи. Допустимые значения: `"Не выполнено"`, `"Выполнено"`, `"Частично выполнено"`. Изначально устанавливается в `"Не выполнено"`.

**6. Команды Бота (Пользовательский Интерфейс)**

* **6.1. `/start`:**
    * При первом запуске:
        * Регистрирует `user_id`.
        * Отправляет приветственное сообщение (текст из `config.py`).
        * Запускает задачи планировщика для пользователя (утро, вечер, мотивация).
        * Предлагает использовать `/setgoal`.
    * При повторном запуске:
        * Отправляет краткое приветствие и напоминание о `/help`.
* **6.2. `/help`:**
    * Отправляет текст справки со списком команд и их кратким описанием (текст из `config.py`).
* **6.3. `/setgoal` (Диалог):**
    * **Начало:** Запускает диалог (`ConversationHandler`). Спрашивает: "Какую цель вы хотите достичь? Опишите её как можно подробнее."
    * **Шаг 1 (Ввод цели):**
        * Пользователь вводит текст цели.
        * Бот проверяет минимальную длину текста.
        * Сохраняет текст цели во временное состояние диалога (`context.user_data`).
        * Спрашивает: "За какой срок вы планируете достичь цели (например, 'за 2 месяца', 'за 6 недель', 'за 50 дней')? Укажите срок до 3 месяцев."
    * **Шаг 2 (Ввод срока):**
        * Пользователь вводит срок.
        * Бот валидирует формат срока и проверяет ограничение в ~90 дней. При ошибке - запрашивает ввод срока повторно.
        * Сохраняет срок во временное состояние.
        * Спрашивает: "Сколько примерно времени вы готовы уделять достижению цели ежедневно (например, '30 минут', '1-2 часа')?"
    * **Шаг 3 (Ввод времени):**
        * Пользователь вводит доступное время.
        * Бот сохраняет время во временное состояние.
        * Бот отправляет сообщение "Генерирую для вас персональный план... Это может занять некоторое время."
        * **Действия в фоне:**
            * Удаление старых данных из Google Sheets (листы `GoalInfo`, `Plan`) для этого `user_id` (через `core.goal_manager`).
            * Вызов модуля `llm` для генерации *полного* ежедневного плана (передаются текст цели, срок, время). Ожидается JSON вида `[{"day": 1, "task": "..."}, {"day": 2, "task": "..."}]`.
            * Обработка ответа LLM (валидация JSON, проверка кол-ва дней). При ошибке LLM - попытка повторного запроса (до 2 раз) или сообщение пользователю об ошибке и выход из диалога.
            * Расчет дат для каждой задачи плана, начиная с сегодняшнего дня.
            * Вызов модуля `sheets` для сохранения новой `GoalInfo` и нового `Plan` в Google Таблицу (через `core.goal_manager`).
        * **Завершение:** Бот отправляет сообщение: "Ваша цель '[Текст цели]' установлена! Я подготовил для вас ежедневный план. Вы можете посмотреть его в вашей Google Таблице: [ссылка на таблицу]. Используйте /today, чтобы увидеть задачу на сегодня, и /check для отметки выполнения." Завершает диалог.
    * **Обработка `/cancel`:** На любом шаге диалога прерывает его, отправляет сообщение "Операция отменена.".
* **6.4. `/today`:**
    * Бот получает `user_id`.
    * Вызывает `core.goal_manager.get_today_task(user_id)`.
    * Если задача найдена: Отправляет сообщение: "📅 Задача на сегодня ({Date}, {DayOfWeek}):\n\n📝 {Task}\n\nСтатус: {Status}".
    * Если цель не установлена: "Сначала установите цель с помощью /setgoal."
    * Если план есть, но задача на сегодня не найдена (ошибка): "Не удалось найти задачу на сегодня в вашем плане."
* **6.5. `/check` (Диалог):**
    * **Начало:** Бот получает `user_id`. Вызывает `core.goal_manager.get_today_task(user_id)`.
    * Если задача найдена и статус `"Не выполнено"` или `"Частично выполнено"`:
        * Отправляет сообщение: "Как сегодня прошел день по задаче:\n\n📝 {Task}\n\nОтметьте статус:" с Inline-кнопками `[✅ Выполнено] [❌ Не выполнено] [🤔 Частично выполнено]`. *Добавить кнопку /cancel? Или использовать команду?*
        * Переходит в состояние ожидания колбэка (`ConversationHandler`).
    * Если задача выполнена: "Отличная работа! Задача на сегодня уже выполнена. ✅"
    * Если цель/задача не найдены: Сообщение об ошибке/отсутствии цели.
    * **Обработка кнопок:**
        * При нажатии на статус: Вызывает `core.goal_manager.update_today_task_status(user_id, выбранный_статус)`. Отправляет подтверждающее сообщение (например, "Статус обновлен! 💪"). Завершает диалог.
* **6.6. `/status`:**
    * Бот получает `user_id`.
    * Вызывает `core.goal_manager.get_goal_status_details(user_id)`.
    * Если цель установлена: Форматирует и отправляет статистику: "📊 Ваш прогресс по цели '{Goal Text}':\nВсего дней в плане: {N}\nПрошло дней: {P}\nОсталось дней: {R}\nВыполнено дней: {D} ({Percent}%)\n\n📝 Ближайшие невыполненные задачи:\n- {Date1}: {Task1}\n- {Date2}: {Task2}\n\n📈 [Ссылка на Google Таблицу]"
    * Если цель не установлена: "Сначала установите цель с помощью /setgoal."
* **6.7. `/motivation`:**
    * Бот получает `user_id`.
    * Вызывает `core.goal_manager.generate_motivation_message(user_id)`.
    * Отправляет полученное сообщение.
* **6.8. `/cancel`:**
    * (Вне диалога) Отправляет "Нет активной операции для отмены."
    * (Внутри диалога /setgoal или /check) Прерывает `ConversationHandler`, отправляет "Операция отменена."

---
---

**7. Логика Работы Основных Модулей**

* **7.1. Модуль Обработчиков Telegram (`handlers/`)**
    * **Назначение:** Содержит функции-обработчики для команд Telegram, сообщений, колбэков и диалоговых состояний. Отвечает за прием ввода от пользователя, вызов соответствующей бизнес-логики из `core`, форматирование и отправку ответов пользователю.
    * **Структура:**
        * `common.py`: Обработчики `/start`, `/help`, `/cancel` (глобальный). Инициализация пользователя, запуск планировщика.
        * `goal_setting.py`: Обработчики для `ConversationHandler` команды `/setgoal`. Управляет шагами диалога (ввод цели, срока, времени), вызывает `core` для обработки и сохранения. Использует `context.user_data` для временного хранения данных диалога.
        * `task_management.py`: Обработчики команд `/today`, `/check` (диалог с кнопками), `/status`, `/motivation`. Вызывают `core` для получения данных, форматируют и отправляют ответы. Обработчик колбэков для кнопок `/check`.
    * **Взаимодействие:** Получает `Update` и `Context` от `python-telegram-bot`. Вызывает методы из `core.goal_manager`, `llm.client`, `sheets.client` (опосредованно через `core`). Формирует ответы и использует `update.message.reply_text`, `query.edit_message_text` и т.д.

* **7.2. Модуль Ядра (`core/`)**
    * **Назначение:** Инкапсулирует основную бизнес-логику приложения, не зависящую от Telegram. Координирует взаимодействие между LLM, Google Sheets и обработчиками Telegram.
    * **Основной Компонент:** Модуль `goal_manager.py` с набором функций, принимающих `user_id` в качестве аргумента.
    * **Ключевые Функции:**
        * `setup_user(user_id)`: Вызывает `sheets.client.create_spreadsheet(user_id)`.
        * `set_new_goal(user_id, goal_text, deadline_str, available_time_str)`: Вызывает `sheets.client.clear_user_data`, `llm.client.generate_plan`, `sheets.client.save_goal_info`, `sheets.client.save_plan`. Возвращает URL или статус.
        * `get_today_task(user_id)`: Получает дату, вызывает `sheets.client.get_task_for_date`.
        * `update_today_task_status(user_id, status)`: Получает дату, вызывает `sheets.client.update_task_status`.
        * `get_goal_status_details(user_id)`: Вызывает `sheets.client.get_statistics`.
        * `generate_motivation_message(user_id)`: Получает цель/статистику, вызывает `llm.client.generate_motivation`.

* **7.3. Модуль LLM (`llm/`)**
    * **Назначение:** Взаимодействие с API OpenAI.
    * **Компоненты:**
        * `client.py`: Класс `LLMClient`.
            * `__init__`: Инициализация `openai.OpenAI` (v >= 1.x).
            * `generate_plan(goal_text, deadline_str, available_time_str)`: Формирует промпт (из `prompts.py`), вызывает `chat.completions.create`, парсит/валидирует JSON `[{"day": int, "task": str}]`, реализует ретраи.
            * `generate_motivation(goal_text, progress_stats)`: Формирует промпт (из `prompts.py`), вызывает `chat.completions.create`, возвращает текст.
        * `prompts.py`: Константы с шаблонами промптов.

* **7.4. Модуль Google Sheets (`sheets/`)**
    * **Назначение:** Работа с Google Sheets API.
    * **Компоненты:**
        * `client.py`: Класс `SheetsManager`.
            * `__init__`: Инициализация `gspread`, аутентификация через service account (`google.oauth2.service_account.Credentials`).
            * `_get_spreadsheet(user_id)`: Находит/создает таблицу.
            * `clear_user_data(user_id)`: Очищает листы `GoalInfo`, `Plan`.
            * `save_goal_info(user_id, goal_data: dict)`: Запись/перезапись `GoalInfo`.
            * `save_plan(user_id, plan: list)`: Запись/перезапись `Plan` (рекомендуется использовать batch update).
            * `get_goal_info(user_id)`: Чтение `GoalInfo`.
            * `get_plan(user_id)`: Чтение `Plan`.
            * `get_task_for_date(user_id, target_date: str)`: Поиск задачи по дате.
            * `update_task_status(user_id, target_date: str, status: str)`: Обновление статуса.
            * `get_statistics(user_id)`: Чтение данных, расчет статистики, поиск следующих задач.
            * Все методы включают обработку ошибок API.

* **7.5. Модуль Планировщика (`scheduler/`)**
    * **Назначение:** Управление фоновыми задачами `APScheduler`.
    * **Компоненты:**
        * `tasks.py`:
            * `init_scheduler()`: Создание `BackgroundScheduler` (timezone из `config`).
            * `add_user_jobs(scheduler, bot, user_id)`: Добавление `cron` и `interval` задач для `user_id` с передачей `bot` и `user_id` через `args`.
                * Утро: Вызов `core.goal_manager.get_today_task` и отправка сообщения.
                * Вечер: Отправка напоминания об использовании `/check`.
                * Мотивация: Вызов `core.goal_manager.generate_motivation_message` и отправка.

**8. Обработка Ошибок**

* **8.1. Ошибки API:** Обертывать вызовы в `try-except`. Информировать пользователя об ошибках внешних сервисов (AI, Sheets). Реализовать ретраи для OpenAI. Логировать детали ошибок.
* **8.2. Ошибки Валидации:** Проверять ввод пользователя в `handlers`. Сообщать об ошибках и запрашивать повторный ввод.
* **8.3. Внутренние Ошибки:** Логировать исключения со стеком. Сообщать пользователю общее сообщение об ошибке.

**9. Журналирование (Логирование)**

* **9.1. Библиотека:** Стандартный модуль `logging`.
* **9.2. Конфигурация:** Уровень (`LOG_LEVEL` из `.env`), формат (`%(asctime)s - %(name)s - %(levelname)s - %(message)s`), вывод в консоль и/или файл (`logs/bot.log`).
* **9.3. События:** Старт/стоп бота, команды пользователя, вызовы API, ошибки, срабатывания планировщика.

---